USE DATABASE
    streams_db;

CREATE OR REPLACE TABLE
    sales_raw_staging(
        id VARCHAR,
        product VARCHAR,
        price VARCHAR,
        amount VARCHAR,
        store_id VARCHAR
    );

INSERT INTO 
    sales_raw_staging
VALUES
    (
        1,'Banana',1.99,1,1
    ),
    (
        2,'Lemon',0.99,1,1
    ),
    (
        3,'Apple',1.79,1,2
    ),
    (
        4,'Orange Juice',1.89,1,2
    ),
    (
        5,'Cereals',5.98,2,1
    );

CREATE OR REPLACE TABLE
    store_table(
        store_id NUMBER,
        location VARCHAR,
        employees NUMBER
    );

INSERT INTO 
    store_table
VALUES
    (
        1,'Chicago',33
    ),
    (
        2,'London',12
    );

CREATE OR REPLACE TABLE
    sales_final_table
    (
        id INT,
        product VARCHAR,
        price NUMBER,
        amount INT,
        store_id INTEGER,
        location VARCHAR,
        employees INTEGER
    );

-- Insert into the final table
INSERT INTO 
    sales_final_table
SELECT
    sa.id,
    sa.product,
    sa.price,
    sa.amount,
    st.store_id,
    st.location,
    st.employees
FROM 
    sales_raw_staging SA
JOIN 
    store_table ST
ON 
    st.store_id=sa.store_id;

-- Create a Stream object
CREATE OR REPLACE STREAM
    sales_stream
ON TABLE 
    sales_raw_staging;

SHOW STREAMS;

DESCRIBE STREAM 
    sales_stream;


SELECT
    *
FROM 
    sales_raw_staging;

SELECT
    *
FROM 
    sales_final_table;

-- Will be empty at first
SELECT
    *
FROM 
    sales_stream;


DELETE FROM 
    sales_raw_staging
WHERE 
    product='Lemon';

-- The metadata$action will display as delete for the product='Lemon'
SELECT
    *
FROM 
    sales_stream;

-- Deleted records observed
SELECT
    *
FROM 
    sales_raw_staging;


-- Process stream--
MERGE INTO
    sales_final_table f
USING 
    sales_stream s
ON 
    f.id=s.id
WHEN MATCHED
AND
    s.metadata$action='DELETE'
AND     
    s.metadata$isupdate='FALSE'
THEN 
    DELETE;
    
-- Stream will be empty once again
SELECT
    *
FROM 
    sales_stream;

-- Delete completed successfully into the final table through streaming
SELECT
    *
FROM 
    sales_final_table;
